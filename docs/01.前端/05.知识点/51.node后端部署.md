---
title: nodeåç«¯éƒ¨ç½²
date: 2025-04-10 16:06:22
permalink: /pages/27beb1/
categories:
  - å‰ç«¯
  - çŸ¥è¯†ç‚¹
tags:
  - 
author: 
  name: åæ€»
  link: https://xiaoying.org.cn/
titleTag: åŸåˆ›
---
## ç›®å½•ç»“æ„

éœ€è¦ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„æ–‡ä»¶å¦‚ä¸‹

```bash
â”œâ”€â”€ backend
â”‚   â””â”€â”€ server.js //nodeåç«¯
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ dist         //æ‰“åŒ…äº§ç‰©
â”‚   â”œâ”€â”€ assets
â”‚   â”œâ”€â”€ favicon.ico
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ nginx
â”‚   â””â”€â”€ default.conf
â”œâ”€â”€ package.json
```

## Dockerfile

```dockerfile
# ä½¿ç”¨ Node å®˜æ–¹é•œåƒ
FROM node:18-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# æ‹·è´åç«¯æ–‡ä»¶ï¼ˆå‡è®¾ server.js å’Œ package.json éƒ½åœ¨å½“å‰ç›®å½•ï¼‰
COPY backend/server.js package.json ./

# å®‰è£…ä¾èµ–å’Œ pm2
RUN npm config set registry https://registry.npmmirror.com && \
    npm install --no-audit --no-fund && \
    npm install -g pm2 --no-audit --no-fund


# å¼€æ”¾ç«¯å£ï¼ˆå¦‚æœåç«¯ç›‘å¬ 3600ï¼‰
EXPOSE 3600

# ä½¿ç”¨ pm2 å¯åŠ¨
CMD ["pm2-runtime", "server.js"]

```

## deploy.sh

```bash
#!/bin/bash
set -e

PROJECT_NAME=sha1-checker

echo "ğŸ”„ åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨..."
sudo docker stop $PROJECT_NAME || true
sudo docker rm $PROJECT_NAME || true

echo "ğŸ”§ æ„å»ºé•œåƒ..."
sudo docker build -t $PROJECT_NAME .

echo "ğŸš€ å¯åŠ¨å®¹å™¨..."
sudo docker run -d \
  --name $PROJECT_NAME \
  -p 3600:3600 \
  $PROJECT_NAME

echo "âœ… éƒ¨ç½²å®Œæˆï¼è®¿é—®: https://maven.xiaoying.org.cn/"

# echo "ğŸ“„ åç«¯æ—¥å¿—è¾“å‡ºï¼š"
docker logs -f $PROJECT_NAME

```

## nginx.conf

```ng
server {
    listen  443 ssl;
    server_name  maven.xiaoying.org.cn;

    ssl_certificate /etc/nginx/fullchain.cer;
    ssl_certificate_key /etc/nginx/xiaoying.org.cn.key;
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    client_max_body_size 50m;

    location / {
        root /usr/local/maven/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_pass http://127.0.0.1:3600;
    }
}

```

## publish.sh

```bash
#!/bin/bash

set -e
set -x

# è¿œç¨‹æœåŠ¡å™¨ä¿¡æ¯
REMOTE_USER="root"
REMOTE_SERVER="æœåŠ¡å™¨IP"
REMOTE_DIR="/usr/local/maven"
NGINX_DIR="/etc/nginx/conf.d"

FILES_TO_COPY="dist backend nginx Dockerfile deploy.sh package.json"

# === æ‰“åŒ…å¹¶æ‹·è´ä»£ç  ===
echo "ğŸ“¦ æ‰“åŒ…ä»£ç ..."

rm -f app.tar.gz
tar czf app.tar.gz $FILES_TO_COPY

echo "ğŸš€ æ‹·è´ä»£ç åˆ°æœåŠ¡å™¨ $REMOTE_SERVER ..."
scp app.tar.gz "$REMOTE_USER@$REMOTE_SERVER:/tmp/app.tar.gz"

# ä¸Šä¼ åˆ°æœåŠ¡å™¨ååˆ é™¤æœ¬åœ°çš„åŒ…
rm -f app.tar.gz

# è¿œç¨‹ç™»å½•å¹¶æ‰§è¡Œéƒ¨ç½²
ssh $REMOTE_USER@$REMOTE_SERVER << EOF

set -e

echo "ğŸ§¹ æ¸…ç†æ—§æ–‡ä»¶..."
rm -rf "$REMOTE_DIR"
mkdir -p "$REMOTE_DIR"
tar xzf /tmp/app.tar.gz -C "$REMOTE_DIR"
rm /tmp/app.tar.gz

# åˆ é™¤æ—§çš„nginxé…ç½®
cd $NGINX_DIR
rm -rf sha1Checker.conf

echo "æ‹·è´ nginx é…ç½®..."
cp $REMOTE_DIR/nginx/default.conf $NGINX_DIR/sha1Checker.conf

#é‡å¯nginx
systemctl restart nginx

echo "ğŸ‰ å‰ç«¯éƒ¨ç½²å®Œæˆï¼Œå¼€å§‹éƒ¨ç½²åç«¯ï¼"

echo "Checking for deploy.sh..."
if [ -f "$REMOTE_DIR/deploy.sh" ]; then
  echo "deploy.sh found."
  cd $REMOTE_DIR
  chmod +x deploy.sh
  ./deploy.sh
else
  echo "deploy.sh not found."
fi
EOF
```

## éƒ¨ç½²

æ‰“å¼€Git Bash ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ

```bash
./publish.sh
```

